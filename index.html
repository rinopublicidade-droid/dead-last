<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Dead Last — Sem Host (Firebase Firestore)</title>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --muted:#8ea0c6; --txt:#e8ecff; --ok:#37d67a; --bad:#ff4d6d; --warn:#ffcc00; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#070a14,#0b1020 40%,#070a14);color:var(--txt)}
    .wrap{max-width:980px;margin:0 auto;padding:16px 14px 48px}
    h1{font-size:18px;margin:0 0 10px;letter-spacing:.2px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:rgba(18,26,51,.92);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;box-shadow:0 10px 24px rgba(0,0,0,.28)}
    .card h2{margin:0 0 10px;font-size:14px;color:#cfd8ff}
    .grow{flex:1 1 320px}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,button{
      width:100%;padding:12px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);color:var(--txt);outline:none
    }
    button{cursor:pointer;background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14);font-weight:650}
    button.primary{background:linear-gradient(135deg,#3b82f6,#8b5cf6);border:none}
    button.ok{background:rgba(55,214,122,.15);border:1px solid rgba(55,214,122,.35)}
    button.bad{background:rgba(255,77,109,.12);border:1px solid rgba(255,77,109,.35)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-size:12px;color:#d6ddff}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:760px){ .grid{grid-template-columns:1fr 1fr} }
    .players{display:flex;flex-direction:column;gap:8px}
    .p{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border-radius:14px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
    .p .left{display:flex;flex-direction:column;gap:2px}
    .name{font-weight:900}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#dbe2ff}
    .tag.dead{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.10);color:#ffd7df}
    .tag.me{border-color:rgba(55,214,122,.35);background:rgba(55,214,122,.12)}
    .tag.power{border-color:rgba(255,204,0,.35);background:rgba(255,204,0,.10);color:#fff3b0}
    .tag.ready{border-color:rgba(59,130,246,.35);background:rgba(59,130,246,.12)}
    .phaseBox{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .phaseTitle{font-size:13px;font-weight:900}
    .timer{font-variant-numeric:tabular-nums;font-weight:900}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .two{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width:760px){ .two{grid-template-columns:1.2fr .8fr} }
    .log{white-space:pre-wrap;min-height:140px;max-height:260px;overflow:auto;font-size:12px;line-height:1.35;color:#e7ebff;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:14px}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Dead Last (fan-made) — sem host (Firestore)</h1>

    <div class="row">
      <div class="card grow">
        <h2>1) Entrar / Criar sala</h2>

        <div class="grid">
          <div>
            <label>Seu nome</label>
            <input id="name" placeholder="Ex.: Lucas" maxlength="24"/>

            <label>Código da sala</label>
            <input id="roomCode" placeholder="Ex.: ABC123" maxlength="10"/>

            <div class="row" style="margin-top:10px">
              <div style="flex:1 1 160px"><button id="btnCreate" class="primary">Criar sala</button></div>
              <div style="flex:1 1 160px"><button id="btnJoin">Entrar na sala</button></div>
            </div>

            <p class="small muted" style="margin:10px 0 0">
              Sem host: o jogo avança por regras automáticas (PRONTO + timers + todos votaram).
            </p>
          </div>

          <div>
            <label>Status</label>
            <div class="pill" id="statusPill">Desconectado</div>

            <div class="hr"></div>

            <label>Link rápido</label>
            <input id="shareLink" readonly placeholder="vai aparecer quando entrar"/>
            <div class="row" style="margin-top:10px">
              <div style="flex:1 1 160px"><button id="btnCopy" class="ok" disabled>Copiar link</button></div>
              <div style="flex:1 1 160px"><button id="btnLeave" class="bad" disabled>Sair</button></div>
            </div>

            <div class="hr"></div>

            <button id="btnReady" class="primary" disabled>✅ Marcar PRONTO</button>
            <p class="small muted" style="margin:10px 0 0">
              No <b>Lobby</b> e após a <b>Revelação</b>, todos os vivos marcam PRONTO pra continuar.
            </p>
          </div>
        </div>
      </div>

      <div class="card grow">
        <h2>2) Mesa</h2>

        <div class="phaseBox">
          <div>
            <div class="phaseTitle" id="phaseTitle">Fase: —</div>
            <div class="small muted">Rodada: <span id="roundN">—</span></div>
          </div>
          <div class="pill">⏱️ <span class="timer" id="timer">00:00</span></div>
        </div>

        <div class="hr"></div>

        <div class="two">
          <div>
            <h2 style="margin:0 0 10px;font-size:14px;color:#cfd8ff">Jogadores</h2>
            <div class="players" id="players"></div>
          </div>

          <div>
            <h2 style="margin:0 0 10px;font-size:14px;color:#cfd8ff">Seu voto</h2>
            <label>Escolha o alvo</label>
            <select id="voteSelect" disabled></select>
            <div class="row" style="margin-top:10px">
              <div style="flex:1 1 160px"><button id="btnVote" class="primary" disabled>Enviar voto</button></div>
              <div style="flex:1 1 160px"><button id="btnUnvote" disabled>Limpar voto</button></div>
            </div>
            <p class="small muted" style="margin:10px 0 0">
              O voto fica salvo no Firestore (UI não mostra). A rodada revela e resolve automaticamente no fim.
            </p>
          </div>
        </div>

        <div class="hr"></div>

        <h2 style="margin:0 0 10px;font-size:14px;color:#cfd8ff">Log</h2>
        <div class="log" id="log"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>Checklist Firebase</h2>
      <ol class="small muted" style="margin:0; padding-left:18px; line-height:1.5">
        <li><b>Firestore Database</b> criado (Cloud Firestore)</li>
        <li>Authentication → habilite <b>Anonymous</b></li>
        <li>Firestore Rules: use um conjunto simples (exemplo no fim do arquivo)</li>
        <li>Hospede no GitHub Pages (ou Firebase Hosting)</li>
      </ol>
      <p class="small muted" style="margin:10px 0 0">
        Para “voto realmente secreto”, já envolve Cloud Functions/criptografia (porque no client puro alguém técnico pode bisbilhotar).
      </p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection,
      deleteDoc, getDocs, serverTimestamp, writeBatch, runTransaction, increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    /******************************************************************
     * firebaseConfig (já preenchido com o seu)
     ******************************************************************/
    const firebaseConfig = {
      apiKey: "AIzaSyBgiZy06DDdDn47dvWXU2eFFiaqJbjhc-8",
      authDomain: "dead-last-711de.firebaseapp.com",
      projectId: "dead-last-711de",
      storageBucket: "dead-last-711de.firebasestorage.app",
      messagingSenderId: "320301717724",
      appId: "1:320301717724:web:f17a0f0534c055e65c3c19"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const UI = (id) => document.getElementById(id);

    const elName = UI("name");
    const elRoom = UI("roomCode");
    const statusPill = UI("statusPill");
    const shareLink = UI("shareLink");
    const btnCopy = UI("btnCopy");
    const btnLeave = UI("btnLeave");
    const btnCreate = UI("btnCreate");
    const btnJoin = UI("btnJoin");
    const btnReady = UI("btnReady");

    const phaseTitle = UI("phaseTitle");
    const roundN = UI("roundN");
    const timerEl = UI("timer");
    const playersEl = UI("players");
    const logEl = UI("log");

    const voteSelect = UI("voteSelect");
    const btnVote = UI("btnVote");
    const btnUnvote = UI("btnUnvote");

    const params = new URLSearchParams(location.search);
    const preRoom = params.get("room");
    if (preRoom) elRoom.value = preRoom.toUpperCase();

    let uid = null;
    let roomId = null;
    let room = null;
    let me = null;
    let unsubRoom = null;
    let unsubPlayers = null;
    let timerInt = null;

    // Ajustes de jogo (sem host)
    const NEGOTIATION_SEC = 180;     // 3 min
    const VOTING_SEC = 60;          // 1 min
    const REVEAL_SEC =_
